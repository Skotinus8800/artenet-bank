<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARTEnet NFC –¢–µ—Ä–º–∏–Ω–∞–ª</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f4f4f4; margin: 0; }
        .terminal-container { max-width: 420px; margin: 0 auto; min-height: 100vh; background: #fff; box-shadow: 0 2px 16px #0002; border-radius: 0 0 18px 18px; position: relative; }
        .header { display: flex; align-items: center; justify-content: space-between; padding: 24px 24px 0 24px; }
        .header h2 { margin: 0; font-size: 1.5em; }
        .settings-btn { background: none; border: none; font-size: 1.7em; cursor: pointer; color: #1976d2; }
        .step { display: none; min-height: 60vh; align-items: center; justify-content: center; flex-direction: column; }
        .step.active { display: flex; }
        .amount-form { width: 100%; max-width: 320px; margin: 0 auto; }
        .amount-form label { font-size: 1.1em; margin-bottom: 8px; display: block; }
        .amount-form input { width: 100%; padding: 16px; font-size: 1.3em; border-radius: 8px; border: 1px solid #bbb; margin-bottom: 18px; }
        .amount-form button { width: 100%; padding: 16px; font-size: 1.2em; background: #1976d2; color: #fff; border: none; border-radius: 8px; cursor: pointer; }
        .amount-form button:disabled { background: #aaa; }
        .pay-card { background: #f7faff; border-radius: 18px; box-shadow: 0 2px 8px #1976d222; padding: 32px 24px; margin: 0 auto; text-align: center; max-width: 340px; }
        .pay-card .sum { font-size: 2.2em; font-weight: bold; margin-bottom: 10px; }
        .pay-card .recipient { font-size: 1.1em; color: #1976d2; margin-bottom: 18px; }
        .pay-card .account { font-size: 1.1em; color: #333; margin-bottom: 8px; }
        .pay-card .btn { margin-top: 18px; }
        .nfc-anim { font-size: 3.5em; margin: 24px 0 12px 0; animation: nfc-pulse 1.2s infinite alternate; }
        @keyframes nfc-pulse { 0% { opacity: 0.7; } 100% { opacity: 1; } }
        .pin-form input { width: 180px; padding: 16px; font-size: 1.5em; border-radius: 8px; border: 1px solid #bbb; text-align: center; }
        .pin-form button { width: 180px; padding: 14px; font-size: 1.1em; background: #1976d2; color: #fff; border: none; border-radius: 8px; margin-top: 18px; }
        .result-block { text-align: center; margin-top: 40px; }
        .result-block .big { font-size: 2.2em; margin-bottom: 12px; }
        .result-block .details { font-size: 1.1em; color: #1976d2; margin-bottom: 18px; }
        .error, .success { text-align: center; font-size: 1.1em; margin: 18px 0 0 0; }
        .error { color: #d32f2f; }
        .success { color: #388e3c; }
        /* –ú–æ–¥–∞–ª–∫–∞ */
        .modal-bg { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100vw; height: 100vh; background: #0007; align-items: center; justify-content: center; }
        .modal-bg.active { display: flex; }
        .modal { background: #fff; border-radius: 14px; padding: 32px 24px; min-width: 320px; max-width: 90vw; box-shadow: 0 4px 24px #0003; }
        .modal h3 { margin-top: 0; }
        .modal input { width: 100%; padding: 12px; font-size: 1.1em; border-radius: 6px; border: 1px solid #bbb; margin-bottom: 18px; }
        .modal .close-btn { background: #d32f2f; color: #fff; border: none; border-radius: 6px; padding: 10px 18px; font-size: 1em; cursor: pointer; float: right; }
        .success-block {
            background: #f7fff7;
            border-radius: 18px;
            box-shadow: 0 2px 12px #1976d222;
            padding: 32px 24px;
            margin: 0 auto;
            text-align: center;
            max-width: 340px;
            border: 2px solid #4caf50;
            opacity: 0;
            transform: translateY(30px);
            animation: fadeInUp 0.7s cubic-bezier(.23,1.01,.32,1) forwards;
        }
        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: none;
            }
        }
        .success-icon {
            font-size: 3em;
            color: #4caf50;
            margin-bottom: 12px;
            animation: popIn 0.5s cubic-bezier(.23,1.01,.32,1);
        }
        @keyframes popIn {
            0% { transform: scale(0.5); opacity: 0; }
            80% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); }
        }
        .success-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 18px;
            color: #388e3c;
        }
        .success-details {
            font-size: 1.1em;
            color: #222;
            text-align: left;
            margin: 0 auto;
            display: inline-block;
        }
        .error { color: #d32f2f; text-align: center; margin-top: 10px; font-size: 1.1em; transition: opacity 0.3s; }
        .error.hide { opacity: 0; pointer-events: none; }
        input[title], select[title] { border-color: #1976d2; }
        input:focus, select:focus { box-shadow: 0 0 0 2px #1976d2aa; }
    </style>
</head>
<body>
<div class="terminal-container">
    <div class="header">
        <h2>ARTEnet –¢–µ—Ä–º–∏–Ω–∞–ª</h2>
        <div id="userEmailBlock" style="font-size:0.95em;color:#1976d2;"></div>
        <button class="settings-btn" id="openSettingsBtn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—è">‚öô</button>
    </div>
    <div id="authBlock" style="display:none;max-width:340px;margin:32px auto 0 auto;padding:24px 18px;background:#fff;border-radius:12px;box-shadow:0 2px 8px #0001;">
        <h3 style="margin-top:0;">–í—Ö–æ–¥ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª</h3>
        <input type="email" id="authEmail" placeholder="Email" style="width:100%;padding:10px;margin-bottom:10px;">
        <input type="password" id="authPassword" placeholder="–ü–∞—Ä–æ–ª—å" style="width:100%;padding:10px;margin-bottom:10px;">
        <button id="authLoginBtn" style="width:100%;padding:12px;background:#1976d2;color:#fff;border:none;border-radius:6px;font-size:1.1em;">–í–æ–π—Ç–∏</button>
        <div class="error" id="authError" style="margin-top:10px;"></div>
    </div>
    <div id="terminalMain">
    <!-- –≠—Ç–∞–ø 1: –í–≤–æ–¥ —Å—É–º–º—ã -->
    <div class="step step-amount active">
        <form class="amount-form" id="amountForm">
            <label for="amount">–°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ:</label>
            <input type="number" id="amount" min="1" step="1" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É" title="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–ª—è –æ–ø–ª–∞—Ç—ã">
            <label for="currencySelect">–í–∞–ª—é—Ç–∞:</label>
            <select id="currencySelect" title="–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞–ª—é—Ç—É –æ–ø–ª–∞—Ç—ã"></select>
            <button type="submit">–î–∞–ª–µ–µ</button>
        </form>
        <div class="error" id="errorMsg"></div>
    </div>
    <!-- –≠—Ç–∞–ø 2: –ö–∞—Ä—Ç–æ—á–∫–∞ –æ–ø–ª–∞—Ç—ã -->
    <div class="step step-paycard">
        <div class="pay-card">
            <div class="sum" id="paySum"></div>
            <div class="recipient" id="payRecipient"></div>
            <button class="btn" id="startNfcBtn">–û–ø–ª–∞—Ç–∏—Ç—å</button>
        </div>
    </div>
    <!-- –≠—Ç–∞–ø 3: –û–∂–∏–¥–∞–Ω–∏–µ NFC -->
    <div class="step step-nfc">
        <div class="nfc-anim">üì∂</div>
        <div class="result-block">
            <div class="big">–ü—Ä–∏–ª–æ–∂–∏—Ç–µ –∫–∞—Ä—Ç—É</div>
            <div class="details" id="nfcDetails"></div>
            <button id="cancelNfcBtn">–û—Ç–º–µ–Ω–∞</button>
        </div>
        <div class="error" id="nfcError"></div>
    </div>
    <!-- –≠—Ç–∞–ø 4: –í–≤–æ–¥ PIN-–∫–æ–¥–∞ -->
    <div class="step step-pin">
        <form class="pin-form" id="pinForm">
            <input type="password" id="pin" maxlength="6" placeholder="PIN-–∫–æ–¥" title="–í–≤–µ–¥–∏—Ç–µ PIN-–∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –≤—ã –∑–∞–¥–∞–ª–∏ –ø—Ä–∏ –ø—Ä–∏–≤—è–∑–∫–µ –∫–∞—Ä—Ç—ã">
            <button type="submit">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
        </form>
        <div class="error" id="pinError"></div>
    </div>
    <!-- –≠—Ç–∞–ø 5: –†–µ–∑—É–ª—å—Ç–∞—Ç -->
    <div class="step step-result">
        <div class="result-block">
            <div class="big" id="resultMsg"></div>
            <div class="details" id="resultDetails"></div>
            <button id="newPaymentBtn">–ù–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂</button>
        </div>
    </div>
    <!-- –ú–æ–¥–∞–ª–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
    <div class="modal-bg" id="settingsModal">
        <div class="modal">
            <button class="close-btn" id="closeSettingsBtn">√ó</button>
            <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—è</h3>
            <label for="recipient">–°—á—ë—Ç/ID –ø–æ–ª—É—á–∞—Ç–µ–ª—è:</label>
            <input type="text" id="recipient" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—á—ë—Ç –∏–ª–∏ ID">
            <button id="saveRecipientBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <div class="success" id="recipientSavedMsg" style="display:none;">–ü–æ–ª—É—á–∞—Ç–µ–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω!</div>
        </div>
    </div>
</div>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script>
// ARTEnet NFC –¢–µ—Ä–º–∏–Ω–∞–ª: —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π UX, –ø–æ–∏—Å–∫ —Å—á—ë—Ç–∞ –ø–æ UID —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

// --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Firebase ---
const firebaseConfig = {
    apiKey: "AIzaSyBZkU-HmTgsFV7McrsDr-Q5WkEBxkA2SD0",
      authDomain: "artenetshop-7b884.firebaseapp.com",
      projectId: "artenetshop-7b884",
      storageBucket: "artenetshop-7b884.appspot.com",
      messagingSenderId: "542098227452",
      appId: "1:542098227452:web:ce14dfbbbd7ca0d34b5779",
      measurementId: "G-8PDLBR77YN",
      databaseURL: "https://artenetshop-7b884-default-rtdb.europe-west1.firebasedatabase.app"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// --- –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ ---
const steps = {
    amount: document.querySelector('.step-amount'),
    paycard: document.querySelector('.step-paycard'),
    nfc: document.querySelector('.step-nfc'),
    pin: document.querySelector('.step-pin'),
    result: document.querySelector('.step-result'),
};
const amountForm = document.getElementById('amountForm');
const amountInput = document.getElementById('amount');
const errorMsg = document.getElementById('errorMsg');
const paySum = document.getElementById('paySum');
const payRecipient = document.getElementById('payRecipient');
const startNfcBtn = document.getElementById('startNfcBtn');
const nfcDetails = document.getElementById('nfcDetails');
const cancelNfcBtn = document.getElementById('cancelNfcBtn');
const nfcError = document.getElementById('nfcError');
const pinForm = document.getElementById('pinForm');
const pinInput = document.getElementById('pin');
const pinError = document.getElementById('pinError');
const resultMsg = document.getElementById('resultMsg');
const resultDetails = document.getElementById('resultDetails');
const newPaymentBtn = document.getElementById('newPaymentBtn');
const openSettingsBtn = document.getElementById('openSettingsBtn');
const settingsModal = document.getElementById('settingsModal');
const closeSettingsBtn = document.getElementById('closeSettingsBtn');
const recipientInput = document.getElementById('recipient');
const saveRecipientBtn = document.getElementById('saveRecipientBtn');
const recipientSavedMsg = document.getElementById('recipientSavedMsg');
const currencySelect = document.getElementById('currencySelect');
const userEmailBlock = document.getElementById('userEmailBlock');
const authBlock = document.getElementById('authBlock');
const authEmailInput = document.getElementById('authEmail');
const authPasswordInput = document.getElementById('authPassword');
const authLoginBtn = document.getElementById('authLoginBtn');
const authError = document.getElementById('authError');
const terminalMain = document.getElementById('terminalMain');

// --- –°–æ—Å—Ç–æ—è–Ω–∏–µ ---
let currentAmount = 0;
let currentRecipient = null;
let foundAccount = null; // {userId, accId, acc, user}
let nfcAbortController = null;

// --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∫–æ–º–∏—Å—Å–∏–∏ –∏ –≤–∞–ª—é—Ç ---
let feePercent = 0.01; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1%
let currencies = {};
let paymentCurrency = 'RUB'; // —Ç–µ–ø–µ—Ä—å –±—É–¥–µ—Ç –º–µ–Ω—è—Ç—å—Å—è –ø–æ–¥ –≤–∞–ª—é—Ç—É —Å—á—ë—Ç–∞
let commission = 0;
let totalToWithdraw = 0;
let accountPassword = '';
let ownerEmail = '';

// --- –ú–æ–¥–∞–ª–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ ---
function openSettings() {
    settingsModal.classList.add('active');
    recipientSavedMsg.style.display = 'none';
}
function closeSettings() {
    settingsModal.classList.remove('active');
}
function safeAddEventListener(element, event, handler) {
    if (element) {
        element.addEventListener(event, handler);
    } else {
        debugLog('Element not found for event:', event);
    }
}
safeAddEventListener(openSettingsBtn, 'click', openSettings);
safeAddEventListener(closeSettingsBtn, 'click', closeSettings);
safeAddEventListener(saveRecipientBtn, 'click', () => {
    const val = recipientInput.value.trim();
    if (val) {
        localStorage.setItem('terminalRecipient', val);
        currentRecipient = val;
        recipientSavedMsg.style.display = 'block';
        setTimeout(() => recipientSavedMsg.style.display = 'none', 1500);
    }
});
safeAddEventListener(amountForm, 'submit', e => {
    e.preventDefault();
    const val = parseFloat(amountInput.value);
    if (!val || val <= 0) {
        showError(errorMsg, '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É!');
        return;
    }
    if (!recipientInput.value.trim()) {
        showError(errorMsg, '–£–∫–∞–∂–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö!');
        return;
    }
    currentAmount = val;
    paymentCurrency = currencySelect ? currencySelect.value : 'RUB';
    paySum.textContent = val + ' ' + paymentCurrency;
    payRecipient.textContent = '–ü–æ–ª—É—á–∞—Ç–µ–ª—å: ' + recipientInput.value.trim();
    showStep('paycard');
});
safeAddEventListener(startNfcBtn, 'click', () => {
    showStep('nfc');
    nfcDetails.textContent = `–°—É–º–º–∞: ${currentAmount} ${paymentCurrency}\n–ü–æ–ª—É—á–∞—Ç–µ–ª—å: ${recipientInput.value.trim()}`;
    startNfcScan();
});
safeAddEventListener(cancelNfcBtn, 'click', () => {
    if (nfcAbortController) nfcAbortController.abort();
    showStep('amount');
});
safeAddEventListener(pinForm, 'submit', e => {
    e.preventDefault();
    const pin = pinInput.value.trim();
    if (!pin) {
        showError(pinError, '–í–≤–µ–¥–∏—Ç–µ PIN-–∫–æ–¥!');
        return;
    }
    if (!foundAccount || !foundAccount.acc.pin) {
        showError(pinError, 'PIN –Ω–µ –∑–∞–¥–∞–Ω –¥–ª—è —ç—Ç–æ–≥–æ —Å—á—ë—Ç–∞!');
        setTimeout(() => showStep('amount'), 2000);
        return;
    }
    if (pin !== foundAccount.acc.pin) {
        showError(pinError, '–ù–µ–≤–µ—Ä–Ω—ã–π PIN-–∫–æ–¥!');
        return;
    }
    processPayment();
});
safeAddEventListener(newPaymentBtn, 'click', () => {
    amountInput.value = '';
    showStep('amount');
});

// --- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —ç—Ç–∞–ø–æ–≤ ---
function showStep(name) {
    Object.values(steps).forEach(s => s.classList.remove('active'));
    steps[name].classList.add('active');
    showError(errorMsg, '');
    showError(nfcError, '');
    showError(pinError, '');
    if (name === 'amount') amountInput.focus();
    if (name === 'pin') pinInput.value = '';
}

// --- –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∞–ª—é—Ç –∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ select ---
function loadCurrenciesAndFillSelect() {
    db.ref('bank/currencies').once('value', snap => {
        currencies = snap.val() || {};
        currencySelect.innerHTML = '';
        Object.entries(currencies).forEach(([code, cur]) => {
            const option = document.createElement('option');
            option.value = code;
            option.textContent = `${code} (${cur.name || ''})`;
            currencySelect.appendChild(option);
        });
        // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é RUB
        currencySelect.value = 'RUB';
        paymentCurrency = 'RUB';
    });
}
if (currencySelect) loadCurrenciesAndFillSelect();

if (currencySelect) {
    currencySelect.addEventListener('change', () => {
        paymentCurrency = currencySelect.value;
    });
}

// --- –≠—Ç–∞–ø 1: –í–≤–æ–¥ —Å—É–º–º—ã ---
safeAddEventListener(amountForm, 'submit', e => {
    e.preventDefault();
    const val = parseFloat(amountInput.value);
    if (!val || val <= 0) {
        showError(errorMsg, '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É!');
        return;
    }
    if (!recipientInput.value.trim()) {
        showError(errorMsg, '–£–∫–∞–∂–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö!');
        return;
    }
    currentAmount = val;
    paymentCurrency = currencySelect ? currencySelect.value : 'RUB';
    paySum.textContent = val + ' ' + paymentCurrency;
    payRecipient.textContent = '–ü–æ–ª—É—á–∞—Ç–µ–ª—å: ' + recipientInput.value.trim();
    showStep('paycard');
});

// --- –≠—Ç–∞–ø 2: –ö–∞—Ä—Ç–æ—á–∫–∞ –æ–ø–ª–∞—Ç—ã ---
startNfcBtn.addEventListener('click', () => {
    showStep('nfc');
    nfcDetails.textContent = `–°—É–º–º–∞: ${currentAmount} ${paymentCurrency}\n–ü–æ–ª—É—á–∞—Ç–µ–ª—å: ${recipientInput.value.trim()}`;
    startNfcScan();
});

// --- –≠—Ç–∞–ø 3: –û–∂–∏–¥–∞–Ω–∏–µ NFC ---
function startNfcScan() {
    if (!('NDEFReader' in window)) {
        showError(nfcError, 'Web NFC –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ!');
        setTimeout(() => showStep('amount'), 2000);
        return;
    }
    nfcAbortController = new AbortController();
    const reader = new NDEFReader();
    reader.scan({ signal: nfcAbortController.signal }).then(() => {
        reader.onreading = event => {
            const uid = event.serialNumber;
            if (!uid) {
                showError(nfcError, '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å UID –º–µ—Ç–∫–∏!');
                setTimeout(() => showStep('amount'), 2000);
                return;
            }
            findAccountByNfcUid(uid);
        };
        reader.onerror = err => {
            showError(nfcError, '–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è NFC: ' + err.message);
            setTimeout(() => showStep('amount'), 2000);
        };
    }).catch(err => {
        showError(nfcError, '–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ NFC: ' + err.message);
        setTimeout(() => showStep('amount'), 2000);
    });
}
cancelNfcBtn.addEventListener('click', () => {
    if (nfcAbortController) nfcAbortController.abort();
    showStep('amount');
});

// --- –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–æ–º–∏—Å—Å–∏–∏ ---
function loadBankSettings() {
    db.ref('bank/payments/settings/fee').once('value', snap => {
        if (snap.exists()) feePercent = parseFloat(snap.val());
    });
    // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞–ª–æ–≥–∞ –Ω–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é
    db.ref('bank/conversionTax').once('value', snap => {
        if (snap.exists()) {
            window.conversionTax = parseFloat(snap.val());
        } else {
            window.conversionTax = 0;
        }
    });
}
loadBankSettings();

// --- –ü–æ–∏—Å–∫ —Å—á—ë—Ç–∞ –ø–æ UID NFC —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ---
function findAccountByNfcUid(uid) {
    debugLog('–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω UID:', uid);
    showError(nfcError, `–ü–æ–∏—Å–∫ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ –±–∞–∑–µ...\nUID: ${uid}`);
    db.ref('bank/accounts').once('value', snap => {
        const accountsRoot = snap.val() || {};
        let found = null;
        let foundUser = null;
        let allUids = [];
        let compareResults = [];
        let usersCount = 0;
        let accountsCount = 0;
        let fullDump = [];
        const uidNorm = String(uid).trim().toLowerCase();
        Object.entries(accountsRoot).forEach(([userId, userAccs]) => {
            usersCount++;
            if (userAccs.accounts) {
                Object.entries(userAccs.accounts).forEach(([accId, acc]) => {
                    accountsCount++;
                    fullDump.push({userId, accId, ...acc});
                    if (acc.nfcUid) {
                        const dbUidNorm = String(acc.nfcUid).trim().toLowerCase();
                        const isMatch = dbUidNorm === uidNorm;
                        allUids.push({
                            nfcUid: acc.nfcUid,
                            user: userAccs.email || userAccs.username || userId,
                            accountNumber: acc.accountNumber || accId,
                            match: isMatch
                        });
                        compareResults.push(`‚Ä¢ ${acc.nfcUid} == ${uid} ? ${isMatch}`);
                        if (isMatch) {
                            found = { userId, accId, acc };
                            foundUser = userAccs;
                        }
                    }
                });
            }
        });
        debugLog('–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', usersCount);
        debugLog('–í—Å–µ–≥–æ —Å—á–µ—Ç–æ–≤:', accountsCount);
        debugLog('–ü–æ–ª–Ω—ã–π –¥–∞–º–ø –≤—Å–µ—Ö —Å—á–µ—Ç–æ–≤:', fullDump);
        debugLog('–í—Å–µ UID –≤ –±–∞–∑–µ:', allUids);
        debugLog('–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:', compareResults.join('\n'));
        if (!found) {
            let uidsList = allUids.length ? allUids.map(u => `‚Ä¢ ${u.nfcUid} ‚Äî ${u.user}, —Å—á—ë—Ç: ${u.accountNumber}, match: ${u.match}`).join('\n') : '–í –±–∞–∑–µ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–π –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ–π –º–µ—Ç–∫–∏.';
            showError(nfcError, `–°—á—ë—Ç —Å —Ç–∞–∫–æ–π –º–µ—Ç–∫–æ–π –Ω–µ –Ω–∞–π–¥–µ–Ω!\nUID –≤–∞—à–µ–π –º–µ—Ç–∫–∏: ${uid}\n\n–í—Å–µ UID –≤ –±–∞–∑–µ:\n${uidsList}\n\n–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:\n${compareResults.join('\n')}\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –º–µ—Ç–∫–∞ –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ —Å—á—ë—Ç—É —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –∏ UID —Å–æ–≤–ø–∞–¥–∞–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é.`);
            debugLog('–ú–µ—Ç–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. UID –≤–∞—à–µ–π –º–µ—Ç–∫–∏:', uid, '–í—Å–µ UID –≤ –±–∞–∑–µ:', allUids, '–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:', compareResults);
            setTimeout(() => showStep('amount'), 12000);
            return;
        }
        foundAccount = { ...found, user: foundUser };
        ownerEmail = foundUser.email || foundUser.username || found.userId;
        showError(nfcError, `–ú–µ—Ç–∫–∞ –Ω–∞–π–¥–µ–Ω–∞!\nUID: ${uid}\n–°—á—ë—Ç: ${found.acc.accountNumber} (${found.acc.currency})`);
        debugLog('–ú–µ—Ç–∫–∞ –Ω–∞–π–¥–µ–Ω–∞! UID:', uid, '–°—á—ë—Ç:', found.acc.accountNumber, found.acc.currency, 'Email –≤–ª–∞–¥–µ–ª—å—Ü–∞:', ownerEmail);
        setTimeout(() => showMultiCurrencyStep(), 1000);
    });
}

// --- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –º—É–ª—å—Ç–∏–≤–∞–ª—é—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∏ PIN ---
function showMultiCurrencyStep() {
    const acc = foundAccount.acc;
    const accCurrency = acc.currency || 'RUB';
    let needConvert = accCurrency !== paymentCurrency;
    let rateX = currencies[paymentCurrency] ? currencies[paymentCurrency].rate : 1;
    let rateY = currencies[accCurrency] ? currencies[accCurrency].rate : 1;
    let converted = currentAmount;
    let conversionFee = 0;
    if (needConvert) {
        converted = +(currentAmount * (rateY / rateX)).toFixed(2);
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞–ª–æ–≥ –Ω–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é
        conversionFee = window.conversionTax ? +(converted * window.conversionTax / 100).toFixed(2) : 0;
    }
    commission = +(converted * feePercent).toFixed(2);
    totalToWithdraw = +(converted + commission + conversionFee).toFixed(2);
    let html = `<div class='pay-card'>
        <div class='sum'>–°—É–º–º–∞: ${currentAmount.toFixed(2)} ${paymentCurrency}</div>`;
    if (needConvert) {
        html += `<div>–ö—É—Ä—Å: 1 ${paymentCurrency} = ${(rateY / rateX).toFixed(4)} ${accCurrency}</div>
        <div>–ë—É–¥–µ—Ç —Å–ø–∏—Å–∞–Ω–æ: ${converted.toFixed(2)} ${accCurrency}</div>
        <div>–ù–∞–ª–æ–≥ –Ω–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é: ${conversionFee.toFixed(2)} ${accCurrency}</div>`;
    }
    html += `<div>–ö–æ–º–∏—Å—Å–∏—è –±–∞–Ω–∫–∞: ${commission.toFixed(2)} ${accCurrency}</div>
        <div style='font-weight:bold;'>–ò—Ç–æ–≥–æ –∫ —Å–ø–∏—Å–∞–Ω–∏—é: ${totalToWithdraw.toFixed(2)} ${accCurrency}</div>
        <form id='pinFormStep' class='pin-form' style='margin-top:24px;'>
            <input type='password' id='pinStepInput' maxlength='6' placeholder='PIN-–∫–æ–¥' title='–í–≤–µ–¥–∏—Ç–µ PIN-–∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –≤—ã –∑–∞–¥–∞–ª–∏ –ø—Ä–∏ –ø—Ä–∏–≤—è–∑–∫–µ –∫–∞—Ä—Ç—ã'>
            <button type='submit'>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å PIN</button>
        </form>
        <div class='error' id='pinStepError'></div>
    </div>`;
    steps.nfc.innerHTML = html;
    setTimeout(() => {
        const pinFormStep = document.getElementById('pinFormStep');
        const pinStepInput = document.getElementById('pinStepInput');
        const pinStepError = document.getElementById('pinStepError');
        if (pinFormStep && pinStepInput) {
            pinFormStep.onsubmit = function(e) {
                e.preventDefault();
                const pin = pinStepInput.value.trim();
                if (!pin) {
                    showError(pinStepError, '–í–≤–µ–¥–∏—Ç–µ PIN-–∫–æ–¥!');
                    return;
                }
                if (!acc.pin) {
                    showError(pinStepError, 'PIN –Ω–µ –∑–∞–¥–∞–Ω –¥–ª—è —ç—Ç–æ–π –∫–∞—Ä—Ç—ã!');
                    return;
                }
                if (pin !== acc.pin) {
                    showError(pinStepError, 'E01: –ù–µ–≤–µ—Ä–Ω—ã–π PIN');
                    return;
                }
                showPinStep = function(){}; // –∑–∞–≥–ª—É—à–∫–∞, —á—Ç–æ–±—ã –Ω–µ –≤—ã–∑—ã–≤–∞–ª–∞—Å—å —Å—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è
                processPayment();
            };
        }
    }, 100);
}

// --- –≠—Ç–∞–ø 4: –í–≤–æ–¥ PIN-–∫–æ–¥–∞ ---
function showPinStep() {
    pinInput.value = '';
    showError(pinError, '');
    showStep('pin');
}

// --- –≠—Ç–∞–ø 5: –°–ø–∏—Å–∞–Ω–∏–µ –∏ –∑–∞–ø–∏—Å—å –ø–ª–∞—Ç–µ–∂–∞ ---
function processPayment() {
    const acc = foundAccount.acc;
    const accCurrency = acc.currency || 'RUB';
    let needConvert = accCurrency !== paymentCurrency;
    let rateX = currencies[paymentCurrency] ? currencies[paymentCurrency].rate : 1;
    let rateY = currencies[accCurrency] ? currencies[accCurrency].rate : 1;
    let converted = currentAmount;
    let conversionFee = 0;
    let conversionRate = 1;
    if (needConvert) {
        conversionRate = rateY / rateX;
        converted = +(currentAmount * conversionRate).toFixed(2);
        conversionFee = window.conversionTax ? +(converted * window.conversionTax / 100).toFixed(2) : 0;
    }
    commission = +(converted * feePercent).toFixed(2);
    totalToWithdraw = +(converted + commission + conversionFee).toFixed(2);
    if (acc.balance === undefined || acc.balance < totalToWithdraw) {
        showError(resultMsg, 'E04: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤');
        resultDetails.textContent = `–ë–∞–ª–∞–Ω—Å: ${acc.balance} ${accCurrency}`;
        showStep('result');
        return;
    }
    const newBalance = acc.balance - totalToWithdraw;
    db.ref(`bank/accounts/${foundAccount.userId}/accounts/${foundAccount.accId}/balance`).set(newBalance)
        .then(() => {
            const payment = {
                fromUserId: foundAccount.userId,
                fromAccountId: foundAccount.accId,
                fromAccountNumber: acc.accountNumber,
                fromUserEmail: ownerEmail,
                amount: currentAmount,
                currency: paymentCurrency,
                to: currentRecipient,
                date: new Date().toISOString(),
                commission: commission,
                conversionFee: conversionFee,
                total: totalToWithdraw,
                accountCurrency: accCurrency,
                conversionRate: conversionRate,
                convertedAmount: converted,
            };
            db.ref('bank/payments/history').push(payment);
            const historyEntry = {
                type: 'payment_out',
                amount: currentAmount,
                commission: commission,
                conversionFee: conversionFee,
                total: totalToWithdraw,
                currency: paymentCurrency,
                accountCurrency: accCurrency,
                convertedAmount: converted,
                conversionRate: conversionRate,
                to: currentRecipient,
                date: new Date().toISOString(),
                description: `–û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ —Ç–µ—Ä–º–∏–Ω–∞–ª. –ü–æ–ª—É—á–∞—Ç–µ–ª—å: ${currentRecipient}`,
            };
            return db.ref(`bank/accounts/${foundAccount.userId}/accounts/${foundAccount.accId}/history`).push(historyEntry);
        })
        .then(() => {
            let details = `<div class='success-block'>
                <div class='success-icon'>‚úî</div>
                <div class='success-title'>–û–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–∞!</div>
                <div class='success-details'>
                    <div><b>–°—á—ë—Ç —Å–ø–∏—Å–∞–Ω–∏—è:</b> ${acc.accountNumber} (${accCurrency})</div>
                    <div><b>–°—É–º–º–∞:</b> ${currentAmount} ${paymentCurrency}</div>`;
            if (needConvert) {
                details += `<div><b>–ö—É—Ä—Å:</b> 1 ${paymentCurrency} = ${(conversionRate).toFixed(4)} ${accCurrency}</div>
                <div><b>–ë—É–¥–µ—Ç —Å–ø–∏—Å–∞–Ω–æ:</b> ${converted.toFixed(2)} ${accCurrency}</div>`;
            }
            details += `<div><b>–ö–æ–º–∏—Å—Å–∏—è:</b> ${commission.toFixed(2)} ${accCurrency}</div>
                    <div><b>–ò—Ç–æ–≥–æ:</b> ${totalToWithdraw.toFixed(2)} ${accCurrency}</div>
                    <div><b>–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</b> ${currentRecipient}</div>
                </div>
            </div>`;
            resultMsg.innerHTML = '';
            resultDetails.innerHTML = details;
            showStep('result');
        })
        .then(() => {
            // --- –ó–∞–ø–∏—Å—å –≤ –∏—Å—Ç–æ—Ä–∏—é –ø–æ–ª—É—á–∞—Ç–µ–ª—è ---
            if (currentRecipient) {
                db.ref('bank/accounts').once('value', snap => {
                    const accountsRoot = snap.val() || {};
                    let foundRecipient = null;
                    Object.entries(accountsRoot).forEach(([userId, userAccs]) => {
                        if (userAccs.accounts) {
                            Object.entries(userAccs.accounts).forEach(([accId, acc]) => {
                                if (acc.accountNumber === currentRecipient) {
                                    foundRecipient = { userId, accId, acc };
                                }
                            });
                        }
                    });
                    if (foundRecipient) {
                        const historyEntry = {
                            type: 'payment_in',
                            amount: currentAmount,
                            commission: commission,
                            total: totalToWithdraw,
                            currency: paymentCurrency,
                            accountCurrency: foundRecipient.acc.currency || accCurrency,
                            convertedAmount: converted,
                            conversionRate: conversionRate,
                            from: acc.accountNumber,
                            date: new Date().toISOString(),
                            description: `–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —Ç–µ—Ä–º–∏–Ω–∞–ª. –û—Ç: ${acc.accountNumber}`,
                        };
                        db.ref(`bank/accounts/${foundRecipient.userId}/accounts/${foundRecipient.accId}/history`).push(historyEntry);
                    }
                });
            }
        })
        .catch(err => {
            showError(resultMsg, '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ: ' + err.message);
            resultDetails.textContent = '';
            showStep('result');
        });
}

// --- –ù–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂ ---
newPaymentBtn.addEventListener('click', () => {
    amountInput.value = '';
    showStep('amount');
});

// --- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ email ---
function updateAuthUI(user) {
    if (user) {
        if (userEmailBlock) userEmailBlock.textContent = user.email || user.uid;
        if (authBlock) authBlock.style.display = 'none';
        if (terminalMain) terminalMain.style.display = '';
    } else {
        if (userEmailBlock) userEmailBlock.textContent = '';
        if (authBlock) authBlock.style.display = '';
        if (terminalMain) terminalMain.style.display = 'none';
    }
}

if (typeof firebase !== 'undefined' && firebase.auth) {
    firebase.auth().onAuthStateChanged(function(user) {
        updateAuthUI(user);
    });
}

if (authLoginBtn) {
    authLoginBtn.onclick = function() {
        if (!authEmailInput.value || !authPasswordInput.value) {
            showError(authError, '–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å!');
            return;
        }
        showError(authError, '');
        firebase.auth().signInWithEmailAndPassword(authEmailInput.value, authPasswordInput.value)
            .then(() => {
                showError(authError, '');
            })
            .catch(err => {
                showError(authError, '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + (err.message || err.code));
            });
    };
}

// --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
showStep('amount');

// --- –ë–ª–æ–∫ –¥–ª—è –≤—ã–≤–æ–¥–∞ –∫–æ–Ω—Å–æ–ª–∏ –Ω–∞ —ç–∫—Ä–∞–Ω ---
function debugLog(...args) {
    const debugDiv = document.getElementById('debugConsole');
    if (debugDiv) {
        debugDiv.style.display = 'block';
        const msg = args.map(a => (typeof a === 'object' ? JSON.stringify(a, null, 2) : String(a))).join(' ');
        debugDiv.innerText += msg + '\n';
        debugDiv.scrollTop = debugDiv.scrollHeight;
    }
    if (window.console) console.log(...args);
}

// --- –ê–≤—Ç–æ-—Å–∫—Ä—ã—Ç–∏–µ –æ—à–∏–±–æ–∫ ---
function showError(elem, msg) {
    if (!elem) return;
    elem.textContent = msg;
    elem.classList.remove('hide');
    setTimeout(() => { elem.classList.add('hide'); }, 3000);
}

// --- –í—Å–ø–ª—ã–≤–∞—é—â–∏–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ ---
// input id="amount" ... placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É" title="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–ª—è –æ–ø–ª–∞—Ç—ã"
// input id="pinStepInput" ... placeholder="PIN-–∫–æ–¥" title="–í–≤–µ–¥–∏—Ç–µ PIN-–∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –≤—ã –∑–∞–¥–∞–ª–∏ –ø—Ä–∏ –ø—Ä–∏–≤—è–∑–∫–µ –∫–∞—Ä—Ç—ã"
// select id="currencySelect" ... title="–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞–ª—é—Ç—É –æ–ø–ª–∞—Ç—ã"
</script>
</body>
</html> 